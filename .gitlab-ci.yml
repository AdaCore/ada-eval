variables:
  UV_PYTHON_DOWNLOADS: never

stages:
  - validate-datasets
  - lint
  - test


.script-snippets:
  # Install the tools needed to run evaluations
  install-eval-tools:
    - anod init wave /it/wave
    - |
      for x in gnat gnatformat; do
        eval "$(cd "/it/wave"; anod install $x; anod printenv $x)"
      done
    - download_generic_package eng/ai/ada-eval /it/gnatprove.tar.gz x86_64-linux-15.1.0
    - tar -xzf /it/gnatprove.tar.gz -C /it/
    - chmod +x /it/gnatprove-x86_64-linux-15.1.0-1/bin/gnatprove
    - export PATH="$PATH:/it/gnatprove-x86_64-linux-15.1.0-1/bin/"


.default:
  services:
    - image:pe-base
  before_script:
    - pip install uv
    - export UV_DEFAULT_INDEX="$PIP_INDEX_URL"
    - export UV_INDEX="$PROJECT_PIP_INDEX_URL"
    - uv venv --python 3.12
    - uv sync
    - git config --global user.email "ci@adacore.com"
    - git config --global user.name "CI"

check-datasets:
  extends: .default
  stage: validate-datasets
  needs: []
  script:
    - !reference [.script-snippets, install-eval-tools]
    - uv run ada-eval check-datasets

.lint:
  extends: .default
  stage: lint
  needs: []
  artifacts:
    reports:
      codequality: $CI_PROJECT_DIR/code-quality-report.json

ruff:
  extends: .lint
  script:
    - uv run ruff check --output-format=gitlab > code-quality-report.json

mypy:
  extends: .lint
  script:
    - uv run mypy --no-error-summary > mypy-out.txt || FAILED=true
    - uv run mypy-gitlab-code-quality < mypy-out.txt > code-quality-report.json
    - if [ ! -z ${FAILED+x} ]; then echo "mypy was unhappy ðŸ˜ž" && exit 1; fi

pytest:
  extends: .default
  stage: test
  needs: []
  script:
    - !reference [.script-snippets, install-eval-tools]
    - uv run pytest --junitxml=report.xml --cov-report xml:coverage.xml
  artifacts:
    when: always
    reports:
      junit: report.xml
      coverage_report:
        coverage_format: cobertura
        path: coverage.xml
  coverage: /TOTAL.*? (100(?:\.0+)?\%|[1-9]?\d(?:\.\d+)?\%)$/
